<!DOCTYPE html>
<html>
  <head>
    <title>Tremor Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      /* üåô Tema Dark Minimalis */
      body {
        background-color: #121212;
        color: #f5f5f5;
        font-family: "Poppins", sans-serif;
        text-align: center;
        margin: 0;
        padding: 0;
      }

      h2 {
        margin-top: 20px;
        font-size: 1.8em;
        letter-spacing: 1px;
      }

      /* üéØ Kontainer utama */
      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      /* üìä Tampilan chart */
      #tremorChart {
        background-color: #1e1e1e;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0px 0px 15px rgba(255, 0, 0, 0.1);
      }

      /* üö® Indikator tremor */
      #tremorIndicator {
        margin-top: 20px;
        padding: 10px 20px;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1.2em;
        transition: 0.3s ease;
      }

      .normal {
        background-color: #222;
        color: #0f0;
        box-shadow: 0 0 10px rgba(0, 255, 0, 0.3);
      }

      .tremor {
        background-color: #ff0000;
        color: white;
        box-shadow: 0 0 20px rgba(255, 0, 0, 0.7);
        animation: blink 1s infinite;
      }

      @keyframes blink {
        50% {
          opacity: 0.5;
        }
      }

      /* üß≠ Footer */
      footer {
        margin-top: 30px;
        font-size: 0.9em;
        color: #777;
      }
    </style>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import {
        getDatabase,
        ref,
        onValue,
      } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

      // üîπ Firebase Config
      const firebaseConfig = {
        apiKey: "AIzaSyCUpSrDPRTvLOot4e4QboWgdJLj_PQByn8",
        authDomain: "parkinson-11301.firebaseapp.com",
        databaseURL: "https://parkinson-11301-default-rtdb.firebaseio.com",
        projectId: "parkinson-11301",
        storageBucket: "parkinson-11301.appspot.com",
        messagingSenderId: "779006164225",
        appId: "779006164225",
      };

      // Inisialisasi Firebase
      const app = initializeApp(firebaseConfig);
      const database = getDatabase(app);

      // üîπ Path ke history dan latest
      const historyRef = ref(database, "tremor_data/esp32_tremor_01/history");
      const latestRef = ref(database, "tremor_data/esp32_tremor_01/latest");

      let ctx = null;
      let tremorChart = null;
      const threshold = 0.8; // ubah sesuai batas tremor deteksi (contoh: 0.8g)
      const indicator = () => document.getElementById("tremorIndicator");

      window.onload = function () {
        ctx = document.getElementById("tremorChart").getContext("2d");

        // Buat chart awal
        tremorChart = new Chart(ctx, {
          type: "line",
          data: {
            labels: [],
            datasets: [
              {
                label: "Tremor Magnitude (g)",
                data: [],
                borderColor: "#ff5252",
                borderWidth: 2,
                fill: false,
              },
            ],
          },
          options: {
            responsive: true,
            animation: false,
            plugins: {
              legend: {
                labels: { color: "#f5f5f5" },
              },
            },
            scales: {
              x: {
                display: true,
                title: { display: true, text: "Time", color: "#ccc" },
                ticks: { color: "#ccc" },
              },
              y: {
                display: true,
                title: { display: true, text: "Magnitude (g)", color: "#ccc" },
                ticks: { color: "#ccc" },
              },
            },
          },
        });

        // üîπ Ambil data history
        onValue(historyRef, (snapshot) => {
          const data = snapshot.val();
          if (data) {
            tremorChart.data.labels = [];
            tremorChart.data.datasets[0].data = [];

            const entries = Object.values(data).sort(
              (a, b) => a.timestamp_ms - b.timestamp_ms
            );
            entries.forEach((entry) => {
              if (
                entry.magnitude !== undefined &&
                entry.timestamp_ms !== undefined
              ) {
                const timeLabel = new Date(
                  entry.timestamp_ms
                ).toLocaleTimeString();
                tremorChart.data.labels.push(timeLabel);
                tremorChart.data.datasets[0].data.push(entry.magnitude);
              }
            });
            tremorChart.update();
          }
        });

        // üîπ Update realtime dari latest
        onValue(latestRef, (snapshot) => {
          const data = snapshot.val();
          if (
            data &&
            data.magnitude !== undefined &&
            data.timestamp_ms !== undefined
          ) {
            const timeLabel = new Date(data.timestamp_ms).toLocaleTimeString();

            // simpan hanya 50 data terakhir supaya chart tidak terlalu panjang
            if (tremorChart.data.labels.length >= 20) {
              tremorChart.data.labels.shift();
              tremorChart.data.datasets[0].data.shift();
            }

            tremorChart.data.labels.push(timeLabel);
            tremorChart.data.datasets[0].data.push(data.magnitude);
            tremorChart.update();

            // üîπ Logika indikator tremor
            if (data.magnitude > threshold) {
              indicator().innerText = "‚ö†Ô∏è Tremor Detected!";
              indicator().classList.remove("normal");
              indicator().classList.add("tremor");
            } else {
              indicator().innerText = "‚úÖ Normal";
              indicator().classList.remove("tremor");
              indicator().classList.add("normal");
            }
          }
        });
      };
    </script>
  </head>
  <body>
    <div class="container">
      <h2>Tremor Tracker Realtime</h2>
      <canvas id="tremorChart" width="600" height="400"></canvas>

      <!-- üîπ Indikator Tremor -->
      <div id="tremorIndicator" class="normal">‚úÖ Normal</div>
    </div>

    <footer>invicta team ‚ù§Ô∏è</footer>
  </body>
</html>

